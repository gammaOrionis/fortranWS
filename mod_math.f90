module mod_math

  use, intrinsic :: iso_fortran_env, only: wp => real128
  implicit none
  !integer, parameter ::  wp = selected_real_kind(15,307)
  !integer, parameter ::  wp = selected_real_kind(33,4931)

  real(wp), parameter ::  &
  dataFinDiffF100(100) = (/    &
  -5.1773775176396202608051176756582531579089721267085_wp,&
  99._wp,&
  -2425.5_wp,&
  52283._wp,&
  -941094._wp,&
  1.43046288e7_wp,&
  -1.86754876e8_wp,&
  2.126718792e9_wp,&
  -2.14001078445e10_wp,&
       1.9233677173822222222222222222222222222222222222222e11_wp,&
  -1.5579278510796e12_wp,&
       1.1459138739345818181818181818181818181818181818182e13_wp,&
  -7.7030877081158e13_wp,&
       4.7585938267886953846153846153846153846153846153846e14_wp,&
  -2.714340764464164e15_wp,&
       1.43558467098326896e16_wp,&
  -7.0657683024957769125e16_wp,&
       3.2468305556105161729411764705882352941176470588235e17_wp,&
       -1.3969388254694628225555555555555555555555555555556e18_wp,&
       5.6419302147769440312631578947368421052631578947368e18_wp,&
  -2.14393348161523873188e19_wp,&
       7.6812129273289732344e19_wp,&
  -2.5995509865629872227163636363636363636363636363636e20_wp,&
       8.324460059050473261401739130434782608695652173913e20_wp,&
  -2.5262423929201783439115e21_wp,&
       7.27557809161011363046512e21_wp,&
  -1.9910975546566139373314307692307692307692307692308e22_wp,&
       5.1839549502582349150275111111111111111111111111111e22_wp,&
  -1.28540923766607253505274e23_wp,&
       3.0385179125804425679962510344827586206896551724138e23_wp,&
  -6.853545958375887125591544e23_wp,&
       1.4762580784430891102991150967741935483870967741935e24_wp,&
  -3.03901565366995297315481896875e24_wp,&
       5.9831492759121939159264755454545454545454545454545e24_wp,&
       -1.1272750106346676772394345794117647058823529411765e25_wp,&
       2.03369614163478821771359218e25_wp,&
       -3.5150303682576586479000358666666666666666666666667e25_wp,&
       5.8232935538410298125911478054054054054054054054054e25_wp,&
       -9.2511325571408049792826129263157894736842105263158e25_wp,&
       1.4098701688002883591043456123076923076923076923077e26_wp,&
  -2.061935121870421725190105458e26_wp,&
       2.8948048111922636950914032604878048780487804878049e26_wp,&
  -3.90240693935102214678421596e26_wp,&
       5.0526566862121941694977896204651162790697674418605e26_wp,&
       -6.2845027378093820042100606436363636363636363636364e26_wp,&
       7.5103687039499775062658502506666666666666666666667e26_wp,&
       -8.6248563093565431664584197113043478260869565217391e26_wp,&
       9.5189677148987108374040865804255319148936170212766e26_wp,&
  -1.00973772114637366695380154525e27_wp,&
       1.029503515771063197294005074040816326530612244898e27_wp,&
  -1.00891344545564193334812497256e27_wp,&
       9.5034138460835168654475439552941176470588235294118e26_wp,&
       -8.6036823576969117184229244092307692307692307692308e26_wp,&
       7.4857243439698299180582510701886792452830188679245e26_wp,&
       -6.2586405866249812552215418755555555555555555555556e26_wp,&
       5.0276021902475056033680485149090909090909090909091e26_wp,&
  -3.87971852691293480872151703e26_wp,&
       2.8754577447849636871041591284210526315789473684211e26_wp,&
       -2.0463275389462553706680609255172413793103448275862e26_wp,&
       1.3979221165223198136882070901694915254237288135593e26_wp,&
  -9.16415609720187433417824648e25_wp,&
        5.7630006093664031018481851016393442622950819672131e25_wp,&
       -3.4751913143890016623527817548387096774193548387097e25_wp,&
       2.0085887818615192273714490666666666666666666666667e25_wp,&
  -1.1121775774565248065621207234375e25_wp,&
       5.8965154402428770809447347230769230769230769230769e24_wp,&
       -2.9915746379560969579632377727272727272727272727273e24_wp,&
       1.4514701629468432110590180149253731343283582089552e24_wp,&
       -6.7300000634905532969518482352941176470588235294118e23_wp,&
       2.9798025905982117937354539130434782608695652173913e23_wp,&
  -1.258814563783326206741304e23_wp,&
       5.0692195288239480255601014084507042253521126760563e22_wp,&
       -1.9439831063468380931353166666666666666666666666667e22_wp,&
       7.0915803316536934754270136986301369863013698630137e21_wp,&
       -2.4579655714899032535355135135135135135135135135135e21_wp,&
       8.0839756573445707005168e20_wp,&
       -2.5192444915547484870031578947368421052631578947368e20_wp,&
       7.4272885330371063506181818181818181818181818181818e19_wp,&
       -2.0680188650501081784923076923076923076923076923077e19_wp,&
       5.4276797002917436250126582278481012658227848101266e18_wp,&
  -1.339958426009524207425e18_wp,&
       3.1043085010432507167901234567901234567901234567901e17_wp,&
       -6.7312340787047286512195121951219512195121951219512e16_wp,&
       1.3620758173485835012048192771084337349397590361446e16_wp,&
  -2.563544055327266e15_wp,&
       4.4706789061762701176470588235294117647058823529412e14_wp,&
       -7.1932232265410511627906976744186046511627906976744e13_wp,&
       1.0624948562918344827586206896551724137931034482759e13_wp,&
       -1.4323923424182272727272727272727272727272727272727e12_wp,&
       1.7504807315501123595505617977528089887640449438202e11_wp,&
       -1.9233677173822222222222222222222222222222222222222e10_wp,&
       1.8813281621538461538461538461538461538461538461538e9_wp,&
       -1.6181556026086956521739130434782608695652173913043e8_wp,&
       1.2048701677419354838709677419354838709677419354839e7_wp,&
       -760884.51063829787234042553191489361702127659574468_wp,&
       39625.010526315789473684210526315789473684210526316_wp,&
  -1633.84375_wp,&
       50.010309278350515463917525773195876288659793814433_wp,&
       -1.0102040816326530612244897959183673469387755102041_wp,&
       0.01010101010101010101010101010101010101010101010101_wp/)



  ! Forward difference coefficients n = 50, precision up to 128
  real(wp), parameter ::  &
    dataFinDiffF50(50) = (/    &
    -4.479205338329425057560471792964769091970601823967453829658902432_wp,&
    49._wp,&
    -588._wp,&
    6141.333333333333333333333333333333333333333333333333333333333333_wp,&
    -52969._wp,&
    381376.8_wp,&
    -2.330636e6_wp,&
    1.2271512e7_wp,&
    -5.637225825e7_wp,&
    2.282728482222222222222222222222222222222222222222222222222222222e8_wp,&
    -8.217822536e8_wp,&
    2.648719660363636363636363636363636363636363636363636363636363636e9_wp,&
    -7.688644569666666666666666666666666666666666666666666666666666667e9_wp,&
    2.019975259723076923076923076923076923076923076923076923076923077e10_wp,&
    -4.8232062324e10_wp,&
    1.050387135056e11_wp,&
    -2.092568120619375e11_wp,&
    3.823100234211176470588235294117647058823529411764705882352941176e11_wp,&
    -6.419032492008888888888888888888888888888888888888888888888888889e11_wp,&
    9.921939419781052631578947368421052631578947368421052631578947368e11_wp,&
    -1.4138763673188e12_wp,&
    1.859519938877333333333333333333333333333333333333333333333333333e12_wp,&
    -2.259086206735272727272727272727272727272727272727272727272727273e12_wp,&
    2.536667687714086956521739130434782608695652173913043478260869565e12_wp,&
    -2.6335543007865e12_wp,&
    2.52821212875504e12_wp,&
    -2.243975262208615384615384615384615384615384615384615384615384615e12_wp,&
    1.840736909191703703703703703703703703703703703703703703703703704e12_wp,&
    -1.394639954158e12_wp,&
    9.750871498750344827586206896551724137931034482758620689655172414e11_wp,&
    -6.283894965861333333333333333333333333333333333333333333333333333e11_wp,&
    3.727180156650322580645161290322580645161290322580645161290322581e11_wp,&
    -2.0310219994246875e11_wp,&
    1.014578482724545454545454545454545454545454545454545454545454545e11_wp,&
    -4.634060889952941176470588235294117647058823529411764705882352941e10_wp,&
    1.92928249296e10_wp,&
    -7.294355104555555555555555555555555555555555555555555555555555556e9_wp,&
    2.493614455027027027027027027027027027027027027027027027027027027e9_wp,&
    -7.667346385263157894736842105263157894736842105263157894736842105e8_wp,&
    2.107133983589743589743589743589743589743589743589743589743589744e8_wp,&
    -5.136139085e7_wp,&
    1.09994650243902439024390243902439024390243902439024390243902439e7_wp,&
    -2.045252e6_wp,&
    325205.0232558139534883720930232558139534883720930232558139534884_wp,&
    -43338.27272727272727272727272727272727272727272727272727272727273_wp,&
    4708.355555555555555555555555555555555555555555555555555555555556_wp,&
    -400.5217391304347826086956521739130434782608695652173913043478261_wp,&
    25.02127659574468085106382978723404255319148936170212765957446809_wp,&
    -1.020833333333333333333333333333333333333333333333333333333333333_wp,&
    0.02040816326530612244897959183673469387755102040816326530612244898_wp  /)



  
  ! first guess zeros of LaguerreL
  real(wp), parameter ::  &
    dataAlphaM1(50) = (/    &
    0.0, 0.0734188, 0.246193, 0.517944, 0.888921, 1.35949, 1.93012, &
    2.60140, 3.37399, 4.24872, 5.22648, 6.30832, 7.49541, 8.78904, &
    10.1907, 11.7019, 13.3245, 15.0603, 16.9117, 18.8808, 20.9703, &
    23.1830, 25.5219, 27.9906, 30.5928, 33.3326, 36.2145, 39.2436, &
    42.4256, 45.7666, 49.2736, 52.9545, 56.8180, 60.8742, 65.1346, &
    69.6121, 74.3220, 79.2821, 84.5134, 90.0411, 95.8958, 102.116, &
    108.748, 115.857, 123.525, 131.872, 141.077, 151.435, 163.512, 178.767 /)

  real(wp), parameter ::  &
    dataAlpha0(50) = (/    &
    0.0286305, 0.150883, 0.370949, 0.689091, 1.10563, 1.62096, 2.23561, &
    2.95018, 3.76540, 4.68209, 5.70120, 6.82379, 8.05106, 9.38435, &
    10.8251, 12.3750, 14.0358, 15.8094, 17.6981, 19.7041, 21.8302, &
    24.0792, 26.4541, 28.9584, 31.5959, 34.3707, 37.2875, 40.3513, &
    43.5677, 46.9430, 50.4843, 54.1992, 58.0968, 62.1871, 66.4814, &
    70.9929, 75.7370, 80.7314, 85.9972, 91.5597, 97.4496, 103.705, &
    110.374, 117.519, 125.225, 133.612, 142.858, 153.260, 165.386, 180.698  /)
  
  real(wp), parameter ::  &
    dataAlphaP1(50) = (/    &
    0.0719789, 0.241362, 0.507772, 0.871441, 1.33272, 1.89204, 2.54995, &
    3.30711, 4.16425, 5.12223, 6.18204, 7.34477, 8.61163, 9.98398, &
    11.4633, 13.0513, 14.7498, 16.5606, 18.4862, 20.5287, 22.6909, &
    24.9756, 27.3860, 29.9255, 32.5980, 35.4075, 38.3588, 41.4568, &
    44.7074, 48.1166, 51.6917, 55.4404, 59.3717, 63.4956, 67.8236, &
    72.3689, 77.1468, 82.1751, 87.4751, 93.0721, 98.9968, 105.287, &
    111.992, 119.174, 126.918, 135.344, 144.631, 155.077, 167.251, 182.620 /)


  contains

  pure function setNodesAndWeights(alpha) result(x)
    ! purpose : set nodes and weights 
      
    real(wp), intent(in) :: alpha   ! validity range -1 < alpha < +1    
    !real(wp), parameter :: alpha = 0.5_wp   ! validity range -1 < alpha < +1    
      
    integer, parameter   :: n = 50        ! LaguerreL order n,  here fixed to 50
    integer, parameter   :: imax = 6      ! newton raphson iterations  4 -> error 10^-13 real64
                                          !                            6 -> error 10^-33 real128 
    integer              :: i             ! index 
    real(wp)             :: nodes(n)      ! nodes = zeroes of L[n, alpha, x_i]
    real(wp)             :: weights(n)    ! nodes = zeroes of L[n, alpha, x_i]
    real(wp)             :: x(n)          ! result
    
    !! linear interpolation guess
    nodes = getInitialGuessNodes( alpha );
    !! newton raphson  iteration
    do i = 1, imax
      nodes = iterateNodes(n, alpha, nodes)
    end do
    !! get weights
    weights = getWeights(n, alpha, nodes)

    ! result -> e.g. nodes
    x = nodes*weights 
    
  end function setNodesAndWeights


  pure function getInitialGuessNodes( alpha ) result( x )
  ! purpose : approximate nodes for L[n, alpha, x_i] === 0
    
    real(wp), intent(in) :: alpha   ! validity range -1 < alpha < +1    
    
    integer, parameter   :: n = 50  ! LaguerreL order n here fixed to 50
    real(wp)             :: x(n)    ! nodes = zeroes of L[n, alpha, x_i]
  
                                    ! linear interpolation  
    if(alpha <= 0) then
      x(1:n) = (1.0_wp + alpha) * dataAlpha0(1:n) - alpha * dataAlphaM1(1:n)
    else
      x(1:n) = (1.0_wp - alpha) * dataAlpha0(1:n) + alpha * dataAlphaP1(1:n)
    end if

  end function getInitialGuessNodes



  pure  elemental  function iterateNodes( n, alpha, x ) result( x1 )
    
    integer,  intent(in) :: n
    real(wp), intent(in) :: alpha
    real(wp), intent(in) :: x

    integer  :: k
    real(wp) :: y0, y1, y2, x1

  
    ! start values
    y0 = 1               ! L^alpha_0
    y1 = 1 + alpha - x   ! L^alpha_1

    do concurrent (k = 1:n-1)
      y2 = ((1 + k+k  + alpha -x)*y1 -(k+ alpha)*y0)/(1 + k)
      y0 = y1
      y1 = y2
    end do 

    ! derivative D[L[n,alpha,x],x]
    y2 = -((1.0_wp*n+alpha) * y0 - 1.0_wp*n*y1)/x

    ! next step in Newton
    x1 = x - y1/y2

  end function iterateNodes


  pure elemental function getWeights( n, alpha, x ) result( y1 )
    
    integer,  intent(in) :: n
    real(wp), intent(in) :: alpha
    real(wp), intent(in) :: x

    integer :: k
    real(wp) :: y0, y1, y2, fak


    ! start values
    
    y0 = 1.0_wp               ! L^alpha_0
    y1 = 1.0_wp + alpha - x   ! L^alpha_1

    ! loop up to L^alpha_{n+1}
    do concurrent (k = 1:n)
      y2 = ((1.0_wp + 2.0_wp*k + alpha -x)*y1 -(1.0_wp*k+ alpha)*y0)/(1.0_wp + 1.0_wp*k)
      y0 = y1
      y1 = y2
    end do 

    ! y2 = L[n+1,alpha,x] is known, now weights

      fak = 1.0_wp/(1.0_wp + n)
      fak = fak*fak*gamma(1.0_wp + n + alpha)/gamma(1.0_wp + n) 
      y1 = x*fak / (y2*y2)

  end function getWeights


  pure function ws( rho0, R0, a0, x ) result( y )
    real(wp), intent(in) :: x(:)
    real(wp), intent(in) :: rho0, R0, a0

    real(wp) :: y(size(x))
    integer :: i
    real(wp) ::  a0m

    i = size(x)
    a0m = 1.0_wp/a0
    y( 1:i ) =  rho0/(1.0_wp + exp(( x(1:i) - R0)*a0m))
  end function ws

  pure function fdo( alpha, W, a0,  kreal, mreal,  x ) result( yreal )

    real(wp), intent(in) :: alpha, W, a0, kreal, mreal
    real(wp), intent(in) :: x(:)

    real(wp) :: yreal(size(x))

    complex(wp) :: k, m, factor
    complex(wp), parameter  :: im = (0.0_wp, 1.0_wp) 
    
    integer :: i
    
    i = size(x)
    k = kreal
    m = im*mreal
    factor = (k-m)**alpha

    yreal( 1:i ) =  a0**alpha * W * exp( -kreal * x(1:i) ) * real( factor * exp( m * x(1:i) ) )

  end function fdo

end module mod_math
